<!doctype html>
<html lang="en">
<head>
  <!-- Preload + Load Material Symbols Rounded -->
  <link rel="preload" href="https://fonts.gstatic.com/s/materialsymbolsrounded/v143/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2" as="font" type="font/woff2" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,700,1,0" rel="stylesheet">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>bndlabs CMS | Admin</title>

  <style>
    :root{
      --bg:#FAFAFB; --panel:#FFFFFF; --panel-2:#FFFFFF; --soft:#F6F7F9; --line:#EAEAEE;
      --text:#0B0B0B; --muted:rgba(11,11,11,.55);
      --accent:#FF4D00; --accent-2:#FF8C00;
      --green:#16A34A; --red:#DC2626; --shadow:0 10px 28px rgba(0,0,0,.06);
      --r:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; line-height:1.5}
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}

    /* Layout */
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100%}
    .side{background:var(--panel-2);border-right:1px solid var(--line);padding:18px;position:sticky;top:0;height:100dvh}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    .brand .logo {display:inline-flex;align-items:center;justify-content:center;width:auto;height:auto;border-radius:0;background:none;box-shadow:none}
    .brand .logo img{width:50px;height:auto;max-height:60px;object-fit:contain}
    .brand .name{font-weight:900}
    .mutey{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.12em;margin:12px 0 8px}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{padding:10px 12px;border-radius:10px;color:#222;display:flex;align-items:center;gap:10px;border:1px solid transparent;transition:.18s}
    .nav a:hover{background:#FFF7F2;border-color:#FFE3D4}
    .nav a.active{background:linear-gradient(120deg,var(--accent),var(--accent-2));color:#fff;font-weight:800;box-shadow:0 8px 20px rgba(255,77,0,.25)}
    .nav a svg{width:16px;height:16px;fill:currentColor;opacity:.9}

    .main{padding:22px;display:grid;gap:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px 14px;box-shadow:var(--shadow)}
    .btn,.ghost{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:800}
    .btn{background:linear-gradient(120deg,var(--accent),var(--accent-2));color:#fff;box-shadow:0 10px 28px rgba(255,77,0,.25)}
    .ghost{background:#fff;color:#111;border:1px solid var(--line)}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .pad{padding:18px}

    /* Tables */
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .search,.select{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#fff}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{color:#444;text-align:left;padding:12px;background:#FCFCFD;border-bottom:1px solid var(--line)}
    tbody td{padding:12px;border-bottom:1px solid var(--line);color:#222;vertical-align:top}
    tbody tr:hover{background:var(--soft)}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:#FFF1E6;color:#A24300;font-weight:700;font-size:12px;border:1px solid #FFD9C2}
    .status{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#EEF2FF;border:1px solid #DDE3FF;color:#334155;font-weight:700;font-size:12px}
    .status[data-s="hidden"]{background:#FEF3C7;border-color:#FDE68A;color:#92400E}
    .status[data-s="draft"]{background:#E5E7EB;border-color:#D1D5DB;color:#374151}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    .tiny{font-size:12px;padding:8px 10px}

    /* Forms */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:1000px){.app{grid-template-columns:1fr}.side{position:relative;height:auto}.grid2{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted);font-weight:800;text-transform:uppercase;letter-spacing:.08em}
    .field{width:100%;padding:12px 14px;border-radius:10px;background:#fff;border:1px solid var(--line);color:#111;outline:none}
    .field:focus{border-color:#FFD3BE;box-shadow:0 0 0 4px rgba(255,141,79,.12)}
    textarea.field{min-height:120px;resize:vertical}
    .row{display:grid;gap:6px}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    /* Sections + Rich Editor */
    .sections{display:flex;flex-direction:column;gap:12px}
    .section{border:1px dashed var(--line);background:#FFFDFB;border-radius:12px;padding:12px}
    .s-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .s-title{font-weight:900;color:#222}
    .s-tools{display:flex;gap:6px}
    .iconbtn{border:1px solid var(--line);background:#fff;color:#111;border-radius:8px;padding:6px 8px;cursor:pointer}
    .iconbtn:hover{background:#FFF6F0;border-color:#FFD9C2}

    /* RTE */
    .rte{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--line);border-radius:10px;padding:6px 8px;margin-bottom:6px}
    .rte .dropdown{position:relative}
    .rte .dd-btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:700}
    .rte .dd{position:absolute;top:100%;left:0;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);padding:6px;display:none;z-index:50}
    .rte .dd button{display:block;width:100%;text-align:left;border:0;background:transparent;padding:8px 10px;border-radius:8px;cursor:pointer}
    .rte .dd button:hover{background:#FFF6F0}
    .rte .btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 8px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;min-width:32px;min-height:32px}
    .rte .btn:hover{background:#FFF6F0;border-color:#FFD9C2}
    .rte .btn svg{width:16px;height:16px;display:block}
    .rich{border:1px solid var(--line);border-radius:10px;padding:12px;min-height:120px;background:#fff}
    .rich:focus{outline:2px solid rgba(255,141,79,.22)}

    .material-symbols-rounded{font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 0, 'opsz' 24; font-size: 20px; line-height: 1; display: inline-block; color: var(--accent);}

    /* Uploader */
    .uploader{border:2px dashed #E9E1DA;border-radius:12px;padding:16px;background:#FFFBF8}
    .uploader p{margin:6px 0 0;font-size:13px;color:#A24300}

    /* Gate */
    .gate{position:fixed;inset:0;background:rgba(255,255,255,.82);backdrop-filter:saturate(1.2) blur(6px);display:flex;align-items:center;justify-content:center;z-index:1000}
    .login{width:min(460px,94vw);background:#fff;border:1px solid var(--line);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
    .login-head{background:linear-gradient(120deg,var(--accent),var(--accent-2));padding:16px;font-weight:900;text-align:center;color:#fff}
    .login-body{padding:16px}

    /* ===== ABOUT TAB POLISH (clean, consistent UI) ===== */
    .about-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:1000px){.about-grid{grid-template-columns:1fr}}
    .about-stack{display:grid;gap:10px}
    .muted{color:var(--muted);font-size:13px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .mini{font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px dashed #FFD7C6;background:#FFF6F0;border-radius:999px;font-weight:700}
    .list{display:grid;gap:8px}
    .inline-tools{display:flex;gap:8px;flex-wrap:wrap}
    .ghost.danger{border-color:#f8c5c5;color:#b80f0f}
    .subtle{color:#666}

  </style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="side">
    <div class="brand">
      <div class="logo"><img src="assets/images/favicon.svg" alt="bndlabs logo"></div>
      <div class="name">Bodunde CMS</div>
    </div>
    <div class="mutey">Manage</div>
    <nav class="nav" id="nav">
      <a href="#" data-panel="portfolio" class="active"><svg viewBox="0 0 24 24"><path d="M4 6h16v12H4zM9 6V4h6v2" /></svg> Portfolio</a>
      <a href="#" data-panel="blog"><svg viewBox="0 0 24 24"><path d="M4 5h16v14H4zM7 8h10M7 12h10M7 16h6"/></svg> Blog</a>
      <a href="#" data-panel="profile"><svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10Zm-8 9c0-3.3 3.6-6 8-6s8 2.7 8 6"/></svg> Profile / Settings</a>
      <a href="#" data-panel="home"><svg viewBox="0 0 24 24"><path d="M3 11l9-8 9 8v9H3z"/></svg> Home</a>
      <a href="#" data-panel="about"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/></svg> About</a>
      <a href="#" data-panel="contact"><svg viewBox="0 0 24 24"><path d="M4 6h16v12H4zM7 9h10M7 13h7"/></svg> Contact</a>
      <a href="#" data-panel="four"><svg viewBox="0 0 24 24"><path d="M4 4h16v16H4zM9 9l6 6M15 9l-6 6"/></svg> 404</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div style="font-weight:900">Admin Dashboard</div>
      <div class="bar">
        <button id="exportBtn" class="ghost tiny">Export JSON</button>
        <label for="importFile" class="ghost tiny" style="cursor:pointer">Import JSON</label>
        <input id="importFile" type="file" accept="application/json" style="display:none">
        <button id="logout" class="ghost tiny">Log out</button>
      </div>
    </div>

    <!-- Projects list -->
    <section class="card" id="panel_portfolio">
      <div class="pad">
        <div class="toolbar">
          <div>
            <div style="font-size:18px;font-weight:900">Projects</div>
            <div style="color:var(--muted);font-size:13px">Newest first, edit or hide.</div>
          </div>
          <div class="bar">
            <input id="projSearch" class="search" placeholder="Search projects…">
            <select id="projFilter" class="select">
              <option value="">All statuses</option><option value="active">Active</option><option value="draft">Draft</option><option value="hidden">Hidden</option>
            </select>
            <button class="btn tiny" id="addProjBtn">➕ Add Project</button>
          </div>
        </div>
        <table>
          <thead><tr>
            <th style="width:34px">#</th><th>Title</th><th style="width:120px">Status</th><th style="width:100px">Views</th>
            <th style="width:140px">Tag</th><th style="width:120px">Date</th><th style="width:160px">Updated</th><th style="width:260px">Actions</th>
          </tr></thead>
          <tbody id="projBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Blog list -->
    <section class="card" id="panel_blog" style="display:none">
      <div class="pad">
        <div class="toolbar">
          <div>
            <div style="font-size:18px;font-weight:900">Blog Posts</div>
            <div style="color:var(--muted);font-size:13px">Image → Heading → Paragraph blocks (rich-text).</div>
          </div>
          <div class="bar">
            <input id="blogSearch" class="search" placeholder="Search posts…">
            <select id="blogFilter" class="select">
              <option value="">All statuses</option><option value="active">Active</option><option value="draft">Draft</option><option value="hidden">Hidden</option>
            </select>
            <button class="btn tiny" id="addBlogBtn">➕ Add Post</button>
          </div>
        </div>
        <table>
          <thead><tr>
            <th style="width:34px">#</th><th>Title</th><th style="width:120px">Status</th><th style="width:100px">Views</th>
            <th style="width:140px">Category</th><th style="width:120px">Date</th><th style="width:160px">Updated</th><th style="width:260px">Actions</th>
          </tr></thead>
          <tbody id="blogBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Project editor -->
    <section class="card" id="panel_editor_proj" style="display:none">
      <div class="pad">
        <div class="bar" style="justify-content:space-between;margin-bottom:6px">
          <div style="font-size:18px;font-weight:900" id="editorProjTitle">New Project</div>
          <div class="bar">
            <button class="ghost tiny" data-back="proj">⟵ Back</button>
            <button class="ghost tiny" id="delProjBtn" style="display:none;color:var(--red);border-color:#432">Delete</button>
            <button class="btn tiny" id="saveProjBtn">Save</button>
          </div>
        </div>

        <div class="grid2">
          <div class="row"><label>Project Title</label><input id="p_title" class="field" placeholder="Monitor app design"></div>
          <div class="row"><label>Tag</label><input id="p_tag" class="field" placeholder="Product design"></div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="row"><label>Date</label><input id="p_date" class="field" placeholder="July 2014"></div>
          <div class="row">
            <label>Hero Image</label>
            <div class="uploader">
              <div class="bar" style="gap:8px"><input id="p_hero" class="field" placeholder="https://…"><input id="p_hero_file" type="file" accept="image/*" class="ghost tiny" style="padding:9px 10px"></div>
              <p>Upload a file or drag and drop — PNG, JPG, SVG up to 1 MB</p>
            </div>
          </div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div class="row"><label>Project Link (Page URL)</label><input id="p_link" class="field" placeholder="project-monitor.html"></div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="row"><label>Status</label><select id="p_status" class="field"><option value="active">Active</option><option value="draft">Draft</option><option value="hidden">Hidden</option></select></div>
          <div class="row"><label>Views</label><input id="p_views" class="field" type="number" min="0" value="0"></div>
        </div>

        <div class="row" style="margin-top:10px"><label>Short Description</label><textarea id="p_desc" class="field" placeholder="A short summary shown at the top…"></textarea></div>

        <div class="bar" style="margin-top:14px">
          <div style="font-weight:900">Sections</div>
          <select id="p_addType" class="field" style="max-width:240px">
            <option value="p">Paragraph</option><option value="h2">Heading</option><option value="img">Image</option>
          </select>
          <button class="ghost tiny" id="p_addSectionBtn">Add Section</button>
        </div>

        <div class="sections" id="p_sections" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- Blog editor -->
    <section class="card" id="panel_editor_blog" style="display:none">
      <div class="pad">
        <div class="bar" style="justify-content:space-between;margin-bottom:6px">
          <div style="font-size:18px;font-weight:900" id="editorBlogTitle">New Blog Post</div>
          <div class="bar">
            <button class="ghost tiny" data-back="blog">⟵ Back</button>
            <button class="ghost tiny" id="delBlogBtn" style="display:none;color:var(--red);border-color:#432">Delete</button>
            <button class="btn tiny" id="saveBlogBtn">Save</button>
          </div>
        </div>

        <div class="grid2">
          <div class="row"><label>Title</label><input id="b_title" class="field" placeholder="Designing for emotion"></div>
          <div class="row"><label>Category / Tag</label><input id="b_tag" class="field" placeholder="UI/UX"></div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="row"><label>Date</label><input id="b_date" class="field" placeholder="02 July 2025"></div>
          <div class="row">
            <label>Hero Image</label>
            <div class="uploader">
              <div class="bar" style="gap:8px"><input id="b_hero" class="field" placeholder="https://…"><input id="b_hero_file" type="file" accept="image/*" class="ghost tiny" style="padding:9px 10px"></div>
              <p>Upload a file or drag and drop — PNG, JPG, SVG up to 1 MB</p>
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="row"><label>Status</label><select id="b_status" class="field"><option value="active">Active</option><option value="draft">Draft</option><option value="hidden">Hidden</option></select></div>
          <div class="row"><label>Views</label><input id="b_views" class="field" type="number" min="0" value="0"></div>
        </div>

        <div class="row" style="margin-top:10px"><label>Subtitle</label><input id="b_sub" class="field" placeholder="Short subheading for the article"></div>

        <div class="bar" style="margin-top:14px">
          <div style="font-weight:900">Sections</div>
          <select id="b_addType" class="field" style="max-width:240px">
            <option value="p">Paragraph</option><option value="h2">Heading</option><option value="img">Image</option>
          </select>
          <button class="ghost tiny" id="b_addSectionBtn">Add Section</button>
        </div>

        <div class="sections" id="b_sections" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- Profile / Settings -->
    <section class="card" id="panel_profile" style="display:none">
      <div class="pad">
        <div style="font-size:18px;font-weight:900;margin-bottom:10px">Profile / Settings</div>

        <div class="grid2">
          <div class="row"><label>Your Name</label><input id="s_name" class="field" placeholder="bndlabs"></div>
          <div class="row"><label>Profession / Title</label><input id="s_title" class="field" placeholder="Product Designer & Front-end Developer"></div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="row"><label>Years of Experience</label><input id="s_years" class="field" type="number" min="0" placeholder="6"></div>
          <div class="row"><label>Location</label><input id="s_location" class="field" placeholder="Lagos, Nigeria"></div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="row"><label>Email</label><input id="s_email" class="field" placeholder="you@example.com"></div>
          <div class="row"><label>Phone</label><input id="s_phone" class="field" placeholder="+234 …"></div>
        </div>

        <div class="row" style="margin-top:10px"><label>Short Bio</label><textarea id="s_bio" class="field" placeholder="A concise about-you paragraph."></textarea></div>

        <div class="row" style="margin-top:10px">
          <label>Profile Photo</label>
          <div class="uploader">
            <div class="bar" style="gap:8px"><input id="s_avatar" class="field" placeholder="https://…"><input id="s_avatar_file" type="file" accept="image/*" class="ghost tiny" style="padding:9px 10px"></div>
            <p>Upload a file or drag and drop — PNG, JPG, SVG up to 1 MB</p>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="row"><label>X (formerly Twitter)</label><input id="s_x" class="field" placeholder="https://x.com/…"></div>
          <div class="row"><label>Instagram</label><input id="s_instagram" class="field" placeholder="https://instagram.com/…"></div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div class="row"><label>Behance</label><input id="s_behance" class="field" placeholder="https://behance.net/…"></div>
          <div class="row"><label>LinkedIn</label><input id="s_linkedin" class="field" placeholder="https://linkedin.com/in/…"></div>
        </div>

        <div class="bar" style="margin-top:16px">
          <button class="btn tiny" id="s_save">Save Profile</button>
          <span id="s_ok" style="display:none;color:var(--green);font-weight:800">Saved ✓</span>
        </div>
      </div>
    </section>

    <!-- Home Page Settings -->
    <section class="card" id="panel_home" style="display:none">
      <div class="pad">
        <div style="font-size:18px;font-weight:900;margin-bottom:10px">Home Page Settings</div>

        <div class="row"><label>Hero Title</label><input id="h_title" class="field" placeholder="UI/UX Designer & Developer"></div>
        <div class="row"><label>Hero Subtitle</label><textarea id="h_sub" class="field" placeholder="Short line below title…"></textarea></div>
        <div class="row"><label>Pill Text</label><input id="h_pill" class="field" placeholder="Design + Code"></div>

        <div class="row"><label>Projects Section Title</label><input id="h_proj_title" class="field" placeholder="Some of my latest work"></div>
        <div class="row"><label>Button Text</label><input id="h_button" class="field" placeholder="See All Work"></div>

        <div class="bar" style="margin-top:16px">
          <button class="btn tiny" id="h_save">Save Home Settings</button>
          <span id="h_ok" style="display:none;color:var(--green);font-weight:800">Saved ✓</span>
        </div>
      </div>
    </section>

    <!-- ABOUT PAGE CMS TAB -->
    <section class="card" id="panel_about" style="display:none">
      <div class="pad">[...]</div>
    </section>

    <!-- CONTACT -->
    <section class="card" id="panel_contact" style="display:none">
      <div class="pad">[...]</div>
    </section>

    <!-- 404 PAGE CMS TAB -->
    <section class="card" id="panel_four" style="display:none">
      <div class="pad">[...]</div>
    </section>

  </main>
</div>

<!-- Password Gate -->
<div class="gate" id="gate">
  <div class="login">
    <div class="login-head">bndlabs Admin Login</div>
    <div class="login-body">
      <div class="row"><label>Password</label><input id="pass" type="password" class="field" placeholder="Enter password"></div>
      <div class="bar" style="margin-top:10px">
        <button class="btn" id="enter">Enter</button>
        <span style="color:var(--muted);font-size:12px">Authenticate with your backend password</span>
      </div>
    </div>
  </div>
</div>

<script>
// Minimal constants
window.BNDLABS_API_BASE = "https://bndlabs-backend.onrender.com";
const API_BASE = (window.BNDLABS_API_BASE || "").replace(/\/+$/,'') + "/api";

/* ===== Shortcuts ===== */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const fmtTime=t=>!t?'—':new Date(t).toLocaleString();
const esc=s=>String(s||'').replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

/* ===== CMSauth — single auth surface (uses backend) ===== */
window.CMSauth = (function () {
  const BASE = API_BASE.replace(/\/api$/, ''); // keep base for building endpoints
  const TOKEN_KEY = "bnd_token";
  function _getToken(){ return sessionStorage.getItem(TOKEN_KEY) || null; }
  function _setToken(t){ if(t) sessionStorage.setItem(TOKEN_KEY,t); else sessionStorage.removeItem(TOKEN_KEY); }

  async function loginAdmin(password){
    if(!password) throw new Error('Password required');
    const res = await fetch(`${BASE}/api/auth/login`,{
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({password})
    });
    if(!res.ok){ const body = await res.json().catch(()=>({})); throw new Error(body?.error||`Login failed (${res.status})`); }
    const body = await res.json().catch(()=>({}));
    const token = body?.token || body?.Token || null; if(!token) throw new Error('No token returned');
    _setToken(token); return { ok:true, token };
  }

  function logout(){ _setToken(null); }
  function authHeaders(add={}){ const t=_getToken(); const h=Object.assign({'Content-Type':'application/json'}, add||{}); if(t) h.Authorization = `Bearer ${t}`; return h; }
  async function authFetch(url, opts={}){ const headers = Object.assign({}, opts.headers||{}, authHeaders()); const cfg = Object.assign({}, opts, { headers }); return fetch(url, cfg); }

  async function postWithAuth(endpoint, data){
    const url = endpoint.startsWith('http') ? endpoint : `${BASE}/api/${endpoint.replace(/^\/+/, '')}`;
    const resp = await authFetch(url, { method:'POST', body: JSON.stringify(data) });
    if(!resp.ok){ const text = await resp.text().catch(()=>''); throw new Error(`Request failed ${resp.status} ${text}`); }
    return resp.json().catch(()=>({ok:true}));
  }

  return { loginAdmin, logout, token: _getToken, authHeaders, authFetch, postWithAuth };
})();

/* ===== Gate / Login UI wiring ===== */
const gate = document.getElementById('gate');
const pass = document.getElementById('pass');
const enter = document.getElementById('enter');
const logoutBtn = document.getElementById('logout');

async function attemptLogin(){
  const pw = pass.value.trim(); if(!pw){ alert('Enter password'); return; }
  try{
    enter.disabled = true;
    const res = await CMSauth.loginAdmin(pw);
    sessionStorage.setItem('bnd_token', res.token);
    gate.style.display = 'none'; pass.value='';
    await prime(); // refresh cache now that we're authed
  }catch(err){ alert('Login failed: '+err.message); }
  finally{ enter.disabled = false; }
}
enter.addEventListener('click', attemptLogin);
pass.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); attemptLogin(); } });
logoutBtn.addEventListener('click', ()=>{ CMSauth.logout(); gate.style.display='flex'; });

/* ===== Storage Keys ===== */
const LS_PROJECTS='cms_projects', LS_BLOGS='cms_blogs', LS_PROFILE='cms_profile', LS_HOME='cms_home', LS_ABOUT='cms_about', LS_CONTACT='cms_contact';

/* ===== Store — uses backend as source of truth; keeps an in-memory cache ===== */
const _cache = { home:{}, projects:[], blogs:[], profile:{}, about:{}, contact:{}, '404':{} };
const KEY_MAP = { [LS_HOME]:'home', [LS_PROJECTS]:'projects', [LS_BLOGS]:'blogs', [LS_PROFILE]:'profile', [LS_ABOUT]:'about', [LS_CONTACT]:'contact', 'cms_404':'404' };
const m = k => KEY_MAP[k] || k;

async function fetchJSON(endpoint, fallback){
  try{
    const r = await fetch(`${API_BASE}/${endpoint}`, { credentials:'omit' });
    if(!r.ok) throw new Error(r.status);
    return await r.json();
  }catch(e){ console.warn(`GET /${endpoint} failed`, e); return fallback; }
}

async function postJSON(endpoint, data){
  // prefer CMSauth.postWithAuth (adds Authorization header), fall back to unauthenticated POST
  if(window.CMSauth && typeof window.CMSauth.postWithAuth === 'function'){
    return window.CMSauth.postWithAuth(endpoint, data);
  }
  const r = await fetch(`${API_BASE}/${endpoint}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
  if(!r.ok) throw new Error(`POST /${endpoint} ${r.status}`);
  return r.json().catch(()=>({ok:true}));
}

async function prime(){
  _cache.home     = await fetchJSON('home', {});
  _cache.projects = await fetchJSON('projects', []);
  _cache.blogs    = await fetchJSON('blogs', []);
  _cache.profile  = await fetchJSON('profile', {});
  _cache.about    = await fetchJSON('about', {});
  _cache.contact  = await fetchJSON('contact', {});
  _cache['404']   = await fetchJSON('404', {});
  try{ typeof renderProjects === 'function' && renderProjects(); }catch{}
  try{ typeof renderBlogs === 'function' && renderBlogs(); }catch{}
}

window.Store = {
  read(key, fallback){ const k=m(key); return structuredClone(_cache[k] ?? JSON.parse(fallback||'{}')); },
  async write(key, value){ const k=m(key); _cache[k]=value; await postJSON(k, value); return {ok:true}; },
  projects(){ const a = Array.isArray(_cache.projects)?[..._cache.projects]:[]; a.sort((x,y)=>(y.updated||0)-(x.updated||0)); return a; },
  putProject(p){ const L=this.projects(); if(!p.id) p.id=(crypto.randomUUID?crypto.randomUUID():String(Date.now())); p.updated=Date.now(); const i=L.findIndex(x=>x.id===p.id); if(i>=0)L[i]=p;else L.unshift(p); _cache.projects=L; return this.write(LS_PROJECTS,L).then(()=>p.id); },
  removeProject(id){ const L=this.projects().filter(x=>x.id!==id); _cache.projects=L; return this.write(LS_PROJECTS,L); },
  byIdProject(id){ return this.projects().find(x=>x.id===id); },
  blogs(){ const a=Array.isArray(_cache.blogs)?[..._cache.blogs]:[]; a.sort((x,y)=>(y.updated||0)-(x.updated||0)); return a; },
  putBlog(b){ const L=this.blogs(); if(!b.id)b.id=(crypto.randomUUID?crypto.randomUUID():String(Date.now())); b.updated=Date.now(); const i=L.findIndex(x=>x.id===b.id); if(i>=0)L[i]=b;else L.unshift(b); _cache.blogs=L; return this.write(LS_BLOGS,L).then(()=>b.id); },
  removeBlog(id){ const L=this.blogs().filter(x=>x.id!==id); _cache.blogs=L; return this.write(LS_BLOGS,L); },
  byIdBlog(id){ return this.blogs().find(x=>x.id===id); },
  profile(){ return structuredClone(_cache.profile||{}); },
  saveProfile(p){ _cache.profile=p; return this.write(LS_PROFILE,p); }
};

// initialize cache (if token exists we will prime as authed)
setTimeout(()=>{ try{ prime(); }catch{} }, 400);

</script>
</body>
</html>
